name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, bcmath, curl, xml

    - name: Install dependencies
      run: |
        composer install --no-interaction

    - name: Run tests
      run: |
        vendor/bin/phpunit --configuration phpunit.xml

    # - name: Display GitHub Actions IP information
    #   run: |
    #     echo "== GitHub Actions IP Information for O2switch Whitelisting =="
    #     RUNNER_IP=$(curl -s https://api.ipify.org)
    #     echo "Current runner IP: $RUNNER_IP"
    #     echo ""
    #     echo "For SFTP deployment, IP whitelisting may still be required in some cases"
    #     echo ""
    #     echo "Current runner IP: $RUNNER_IP"
        
    #     # Save the current IP for reference
    #     echo "$RUNNER_IP" > runner_ip.txt

    - name: Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: choucas.o2switch.net
        username: rame5605
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: 21
        local-dir: ./
        server-dir: /home/rame5605/api.herbeginfos.fr/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          README.md
          .env.example
          phpunit.xml
          tests/**
          vendor/**
        
    # - name: Post-deployment commands (optional)
    #   if: false
    #   uses: appleboy/ssh-action@master
    #   with:
    #     host: 109.234.166.50
    #     username: rame5605
    #     key: ${{ secrets.SSH_PRIVATE_KEY }}
    #     script: |
    #       cd /home/rame5605/api.herbeginfos.fr
    #       composer install --no-dev
    #       php artisan migrate --force
